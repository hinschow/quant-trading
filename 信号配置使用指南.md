# 信号配置系统使用指南 v7.3

## 问题背景

回测结果显示：
- ❌ **胜率极低**: 18-20%（正常应>40%）
- ❌ **全部亏损**: 所有周期都是负收益
- ❌ **信号太多**: 指标太多导致低质量信号频繁出现

## 解决方案：可配置信号过滤系统

### 核心改进

1. **3种预设方案**：保守/简化/自定义
2. **灵活指标开关**：每个指标都可启用/禁用
3. **动态阈值调整**：买卖阈值可配置
4. **市场状态过滤**：禁止在震荡市/中性市交易
5. **额外过滤条件**：ADX、RSI、成交量等

---

## 快速开始

### 1️⃣ 测试新配置

```bash
# 对比原版和v7.3的信号差异
python3 test_signal_config.py BTC/USDT

# 扫描最近100根K线的信号统计
python3 test_signal_config.py BTC/USDT --scan

# 测试其他交易对
python3 test_signal_config.py SUI/USDT
```

### 2️⃣ 选择配置方案

编辑 `config/signal_filter_config.py` 第14行：

```python
# 使用哪个方案？ 'CONSERVATIVE' / 'SIMPLIFIED' / 'CUSTOM'
ACTIVE_PRESET = 'CONSERVATIVE'  # 改为你想用的方案
```

---

## 3种预设方案详解

### 方案A：保守精确（推荐）

**目标**：胜率>40%，宁缺毋滥

**配置**：
- ⬆️ **阈值提高**：买入60分，卖出60分（原40分）
- ✂️ **减少指标**：禁用KDJ、VWAP
- 🔒 **严格过滤**：
  - 必须ADX>30（强趋势）
  - 必须成交量确认
  - 禁止在震荡市/中性市交易
  - 加强量价背离惩罚（-40/-30/-20/-10分）

**启用指标** (8/10)：
- ✅ EMA（金叉50分）
- ✅ MACD（金叉40分）
- ✅ ADX（趋势10分）
- ✅ RSI（健康15分）
- ✅ Volume（确认15分）
- ✅ OBV（上升15分，背离严惩）
- ✅ Funding Rate
- ✅ Smart Money
- ❌ KDJ（禁用）
- ❌ VWAP（禁用）

**适合场景**：
- 追求稳定盈利
- 不在意交易频率低
- 避免频繁亏损

---

### 方案B：核心简化

**目标**：只用最可靠的5个指标

**配置**：
- ⬆️ **阈值**：买入50分，卖出50分
- ✅ **保留核心**：EMA、MACD、ADX、RSI、Volume
- ❌ **移除**：KDJ、OBV、VWAP、Smart Money

**启用指标** (6/10)：
- ✅ EMA
- ✅ MACD
- ✅ ADX
- ✅ RSI
- ✅ Volume
- ✅ Funding Rate
- ❌ KDJ
- ❌ OBV（量价背离太复杂）
- ❌ VWAP
- ❌ Smart Money（数据可能不稳定）

**适合场景**：
- 不想处理复杂指标
- 追求简单可靠
- 数据源有限

---

### 方案C：灵活自定义

**目标**：完全自己配置

**使用方法**：

1. 编辑 `config/signal_filter_config.py`
2. 找到 `CUSTOM_CONFIG` 部分（第196行）
3. 修改配置：

```python
CUSTOM_CONFIG = {
    # 自定义阈值
    "thresholds": {
        "trend_buy": 50,         # 趋势买入阈值
        "trend_sell": 50,
        "mean_reversion_buy": 40,
        "mean_reversion_sell": 40,
    },

    # 自定义指标开关
    "indicators": {
        "ema": {"enabled": True, ...},   # 改为False禁用
        "macd": {"enabled": True, ...},
        "kdj": {"enabled": False, ...},  # 禁用KDJ
        # ... 根据需要修改
    },

    # 自定义市场状态过滤
    "market_regime_filter": {
        "STRONG_TREND": True,   # 允许强趋势交易
        "TREND": True,
        "RANGE": False,         # 禁止震荡市交易
        "SQUEEZE": False,
        "NEUTRAL": False,
    },

    # 自定义额外过滤
    "extra_filters": {
        "min_adx": 25,          # 最低ADX要求
        "max_rsi_for_buy": 80,  # 买入RSI上限
        # ...
    }
}
```

---

## 使用新引擎运行回测

### 方法1：修改现有回测脚本

编辑 `backtest_engine.py` 第14行：

```python
# 从这里
from strategy_engine import StrategyEngine

# 改为
from strategy_engine_v73 import StrategyEngineV73 as StrategyEngine
```

然后正常运行回测：

```bash
python3 run_multi_timeframe_backtest.py
```

### 方法2：创建新的回测脚本

复制并修改 `backtest_engine.py`：

```bash
cp backtest_engine.py backtest_engine_v73.py
```

修改第14行导入v7.3引擎，然后：

```bash
python3 backtest_engine_v73.py BTC/USDT -t 30m --limit 3000
```

---

## 配置调优建议

### 如果信号太少

1. **降低阈值**：
   ```python
   "trend_buy": 50,  # 从60降到50
   ```

2. **启用更多指标**：
   ```python
   "kdj": {"enabled": True, ...},
   ```

3. **放宽市场状态**：
   ```python
   "RANGE": True,  # 允许震荡市交易
   ```

### 如果信号质量仍然差

1. **提高阈值**：
   ```python
   "trend_buy": 70,  # 更严格
   ```

2. **加强过滤**：
   ```python
   "min_adx": 35,  # 更高的ADX要求
   "require_volume_confirmation": True,
   ```

3. **禁用更多指标**：
   ```python
   "obv": {"enabled": False},  # 禁用OBV
   ```

---

## 预期效果

### 保守精确方案

**预期改进**：
- 信号数量：减少40-60%
- 胜率：从20% → 35-45%
- 总收益：从-20% → -5%到+5%
- 盈亏比：从0.8 → 1.5+

**权衡**：
- ✅ 更少的亏损交易
- ✅ 更高的信号质量
- ❌ 交易频率降低
- ❌ 可能错过部分机会

### 核心简化方案

**预期改进**：
- 信号数量：减少30-50%
- 胜率：从20% → 30-40%
- 更稳定、更易理解

---

## 对比测试结果示例

运行 `python3 test_signal_config.py BTC/USDT --scan` 可能看到：

```
原版引擎（v7.2）:
  买入:   15 (15.0%)
  卖出:   12 (12.0%)
  观望:   73 (73.0%)

优化引擎（v7.3）:
  买入:    8 (8.0%)   ← 减少47%
  卖出:    6 (6.0%)   ← 减少50%
  观望:   86 (86.0%)

差异:
  原版活跃信号:  27次
  v7.3活跃信号:  14次
  信号减少:      48.1%  ← 过滤掉近一半低质量信号
```

---

## 故障排查

### 问题：ImportError

```bash
# 确保在项目根目录
cd /home/andre/code/quant-trading

# 或在Mac上
cd "/Volumes/datedisk 3/code/quant-trading"
```

### 问题：配置不生效

检查 `config/signal_filter_config.py` 第14行：

```python
ACTIVE_PRESET = 'CONSERVATIVE'  # 确认是你想用的方案
```

### 问题：回测结果无变化

确认你使用的是v7.3引擎：

```python
from strategy_engine_v73 import StrategyEngineV73 as StrategyEngine
```

---

## 下一步

1. **测试配置**：
   ```bash
   python3 test_signal_config.py BTC/USDT --scan
   ```

2. **选择方案**：
   - 编辑 `config/signal_filter_config.py`
   - 设置 `ACTIVE_PRESET`

3. **运行回测**：
   ```bash
   # 修改 backtest_engine.py 导入v7.3
   python3 run_multi_timeframe_backtest.py
   ```

4. **分析结果**：
   ```bash
   python3 analyze_results.py
   ```

5. **调优配置**：
   - 根据回测结果调整阈值和指标
   - 重复2-4步

---

## 文件清单

新增文件：
- ✅ `config/signal_filter_config.py` - 配置文件（3种方案）
- ✅ `strategy_engine_v73.py` - 新引擎（支持配置）
- ✅ `test_signal_config.py` - 测试脚本
- ✅ `信号配置使用指南.md` - 本文档

需要修改的文件（可选）：
- `backtest_engine.py` - 第14行导入v7.3引擎

---

**版本**: v7.3
**最后更新**: 2025-10-28
