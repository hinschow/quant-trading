# 本地数据持久化 + 快速回测指南

## 🎯 核心优势

### 为什么需要本地数据？

1. **速度快** - 不用每次从API拉取，秒级完成回测
2. **持续积累** - 数据永久保存，越用越多
3. **灵活调参** - 快速验证不同参数配置
4. **节省资源** - 减少API调用，避免限流

---

## 📦 系统架构

```
本地数据持久化系统
├── data/cache/              # 数据缓存目录
│   ├── BTC_USDT_1h.csv     # BTC 1小时数据
│   ├── BTC_USDT_30m.csv    # BTC 30分钟数据
│   ├── ETH_USDT_1h.csv
│   └── ...
├── data_cache_manager.py    # 数据管理器
├── fast_backtest.py          # 快速回测引擎
└── config/signal_filter_config.py  # 信号配置（4种方案）
```

---

## 🚀 快速开始

### 步骤1：下载历史数据

```bash
# 下载单个交易对的数据
python3 data_cache_manager.py update --symbol BTC/USDT --timeframe 1h

# 下载所有配置的交易对（推荐）
python3 data_cache_manager.py update --all
```

**说明**：
- 首次运行会拉取1000根K线（约40天）
- 数据保存在 `data/cache/` 目录
- 后续运行只会追加最新数据

---

### 步骤2：查看缓存统计

```bash
python3 data_cache_manager.py stats
```

**输出示例**：
```
================================================================================
📊 本地数据缓存统计
================================================================================
缓存目录: /path/to/data/cache
文件总数: 24
总大小:   12.45 MB

文件名                     数据条数    天数      大小        时间范围
--------------------------------------------------------------------------------
BTC_USDT_15m.csv          2880       30       0.45 MB   2025-09-28 ~ 2025-10-28
BTC_USDT_1h.csv           720        30       0.12 MB   2025-09-28 ~ 2025-10-28
BTC_USDT_30m.csv          1440       30       0.23 MB   2025-09-28 ~ 2025-10-28
...
================================================================================
```

---

### 步骤3：配置信号方案

编辑 `config/signal_filter_config.py` 第18行：

```python
# 使用哪个方案？
ACTIVE_PRESET = 'BALANCED'  # 平衡方案（推荐）
```

**4种方案对比**：

| 方案 | 阈值 | 市场状态 | 特点 | 适用场景 |
|-----|------|---------|------|---------|
| **BALANCED** ⭐ | 趋势50/震荡40 | 允许震荡市 | 平衡质量和数量 | 大部分情况（推荐） |
| CONSERVATIVE | 趋势60/震荡50 | 只允许趋势市 | 高质量低频率 | 追求稳定盈利 |
| SIMPLIFIED | 趋势50/震荡40 | 只允许趋势市 | 5个核心指标 | 简单可靠 |
| CUSTOM | 自定义 | 自定义 | 完全可配置 | 高级用户 |

---

### 步骤4：快速回测

```bash
# 回测单个交易对
python3 fast_backtest.py BTC/USDT -t 1h

# 回测所有交易对（批量）
python3 fast_backtest.py --all

# 指定日期范围
python3 fast_backtest.py BTC/USDT -t 30m --start 2025-09-01 --end 2025-10-27
```

**输出示例**：
```
================================================================================
📊 回测结果
================================================================================

【基本信息】
  初始资金:      $  10,000.00
  最终权益:      $  10,438.00
  总收益:        $     438.00 (+4.38%)
  年化收益率:            53.26%
  最大回撤:             -12.50%

【交易统计】
  总交易次数:                8
  盈利次数:                  5
  亏损次数:                  3
  胜率:                  62.50%

【盈亏分析】
  平均盈利:      $     120.00
  平均亏损:      $      45.00
  盈亏比:                2.67:1
================================================================================
```

---

## 🎛️ 配置方案详解

### 方案1：平衡方案（BALANCED）⭐ 推荐

**特点**：
- 阈值适中（50/40分）
- **允许震荡市交易**
- 启用OBV和聪明钱包
- 不强制要求成交量确认

**配置**：
```python
"thresholds": {
    "trend_buy": 50,
    "trend_sell": 50,
    "mean_reversion_buy": 40,
    "mean_reversion_sell": 40,
},

"market_regime_filter": {
    "STRONG_TREND": True,
    "TREND": True,
    "RANGE": True,     # ← 关键：允许震荡市
    "SQUEEZE": False,
    "NEUTRAL": False,
},

"extra_filters": {
    "min_adx": 20,     # 降低ADX要求
    "require_volume_confirmation": False,  # 不强制
}
```

**预期效果**：
- 信号数量：中等（比保守方案多30-50%）
- 胜率：35-45%
- 适合：大部分市场环境

---

### 方案2：保守精确（CONSERVATIVE）

**特点**：
- 阈值高（60/50分）
- 只在趋势市交易
- 强制成交量确认
- ADX>30

**适合场景**：
- 追求稳定盈利
- 不在意交易频率低
- 避免震荡市亏损

---

### 方案3：核心简化（SIMPLIFIED）

**特点**：
- 只用5个核心指标
- 禁用OBV、KDJ、VWAP、Smart Money
- 简单可靠

**适合场景**：
- 不想处理复杂指标
- 数据源有限
- 快速验证

---

### 方案4：自定义（CUSTOM）

完全自己配置，适合高级用户。

---

## 📊 日常使用流程

### 每日更新数据

```bash
# 更新所有交易对的最新数据
python3 data_cache_manager.py update --all
```

这个命令会：
1. 检查每个文件的最后时间
2. 只拉取缺失的新数据
3. 合并到现有文件

---

### 快速调参验证

```bash
# 1. 测试不同阈值
# 编辑 config/signal_filter_config.py，调整阈值

# 2. 快速回测验证
python3 fast_backtest.py BTC/USDT -t 30m

# 3. 对比结果，继续调整
```

**典型调参流程**：

```python
# 第1轮：测试阈值50
"trend_buy": 50,
# → 回测：胜率30%，信号多

# 第2轮：提高到55
"trend_buy": 55,
# → 回测：胜率35%，信号适中

# 第3轮：测试60
"trend_buy": 60,
# → 回测：胜率40%，信号少

# 结论：使用55分平衡
```

---

### 批量回测对比

```bash
# 回测所有交易对，找出最优币种
python3 fast_backtest.py --all
```

**输出示例**：
```
================================================================================
📊 批量回测汇总
================================================================================

BTC_USDT_1h          收益:   +4.38% | 胜率:  62.5% | 交易:   8笔
ETH_USDT_1h          收益:   -5.41% | 胜率:  20.0% | 交易:  10笔
SOL_USDT_1h          收益:  +20.29% | 胜率:  50.0% | 交易:   8笔
SUI_USDT_1h          收益:  +18.19% | 胜率:  52.9% | 交易:  17笔
...
================================================================================
```

根据结果：
- ✅ 保留表现好的币种（SOL、SUI）
- ❌ 移除表现差的币种（ETH）

---

## 🔧 高级功能

### 1. 指定日期范围回测

```bash
# 只回测最近1个月
python3 fast_backtest.py BTC/USDT -t 1h --start 2025-09-28 --end 2025-10-28

# 回测特定时期
python3 fast_backtest.py SOL/USDT -t 30m --start 2025-10-01 --end 2025-10-15
```

---

### 2. 数据管理

```bash
# 查看统计
python3 data_cache_manager.py stats

# 清理特定文件
python3 data_cache_manager.py clear --symbol BTC/USDT --timeframe 1h

# 清理所有缓存（慎用）
python3 data_cache_manager.py clear
```

---

### 3. 切换配置方案

方法1：修改配置文件
```python
# config/signal_filter_config.py 第18行
ACTIVE_PRESET = 'BALANCED'  # 改为其他方案
```

方法2：Python脚本切换
```python
from config.signal_filter_config import switch_to_balanced, switch_to_conservative

# 切换到平衡方案
switch_to_balanced()

# 切换到保守方案
switch_to_conservative()
```

---

## 📈 优化策略参数

### 常见调优场景

#### 场景1：信号太少

**问题**：回测期间只有3-5个交易信号

**解决**：
1. 降低阈值：
   ```python
   "trend_buy": 45,  # 从50降到45
   ```

2. 允许更多市场状态：
   ```python
   "RANGE": True,     # 允许震荡市
   "SQUEEZE": True,   # 允许挤压市
   ```

3. 降低ADX要求：
   ```python
   "min_adx": 15,  # 从20降到15
   ```

---

#### 场景2：胜率太低（<30%）

**问题**：交易很多但亏损居多

**解决**：
1. 提高阈值：
   ```python
   "trend_buy": 60,  # 从50提高到60
   ```

2. 禁止震荡市：
   ```python
   "RANGE": False,  # 只在趋势市交易
   ```

3. 强制成交量确认：
   ```python
   "require_volume_confirmation": True,
   ```

---

#### 场景3：回撤太大（>20%）

**问题**：收益可观但回撤巨大

**解决**：
1. 调整止损：
   ```python
   # 修改 config/strategy_params.py
   "stop_loss_pct": 0.02,  # 从3%收紧到2%
   ```

2. 降低仓位：
   ```python
   # fast_backtest.py
   backtest = FastBacktest(position_size_pct=0.7)  # 70%仓位
   ```

---

## 💡 最佳实践

### 1. 定期更新数据

建议每天运行一次：
```bash
# 添加到crontab（每天早上9点）
0 9 * * * cd /path/to/quant-trading && python3 data_cache_manager.py update --all
```

### 2. 多方案对比

同时测试多个方案，选最优：
```bash
# 1. 测试平衡方案
# 修改配置为BALANCED，运行回测

# 2. 测试保守方案
# 修改配置为CONSERVATIVE，运行回测

# 3. 对比结果
```

### 3. 交易对筛选

定期评估各交易对表现：
```bash
# 批量回测
python3 fast_backtest.py --all

# 根据结果调整 config/strategy_params.py 的 TRADING_SYMBOLS
```

### 4. 参数版本管理

使用Git管理配置变更：
```bash
# 每次调整参数后提交
git add config/signal_filter_config.py
git commit -m "调整阈值：50→55，胜率提升5%"
```

---

## 🆚 原版 vs 快速回测对比

| 特性 | 原版回测 | 快速回测 |
|-----|---------|---------|
| 数据来源 | 每次API拉取 | 本地缓存 |
| 速度 | 慢（30-60秒） | 快（1-5秒） |
| 历史数据 | 有限（1000根） | 无限（持续积累） |
| 日期范围 | 固定 | 自由指定 |
| 参数调优 | 慢 | 快 |
| API限流 | 易触发 | 无影响 |

---

## ❓ 常见问题

### Q1: 缓存数据会过期吗？
**A**: 不会。但建议每天更新最新数据。

### Q2: 如何删除旧数据？
**A**: 数据不需要删除，越积累越好。如果硬盘空间紧张，可以清理不用的交易对。

### Q3: 快速回测结果准确吗？
**A**: 完全准确。使用相同数据和策略引擎，结果与原版回测一致。

### Q4: 支持实时交易吗？
**A**: 不支持。这是回测系统，用于策略验证。实时交易需要另外实现。

### Q5: 如何导出回测结果？
**A**: 修改 `fast_backtest.py`，添加导出CSV功能（可参考原版的导出代码）。

---

## 📝 总结

本地数据持久化系统让你可以：

1. ✅ **快速验证**：秒级完成回测
2. ✅ **灵活调参**：快速对比不同配置
3. ✅ **持续优化**：数据越积累越丰富
4. ✅ **节省资源**：减少API调用

配合**平衡方案（BALANCED）**，在信号质量和数量之间找到最佳平衡。

---

**版本**: v7.3
**最后更新**: 2025-10-28
