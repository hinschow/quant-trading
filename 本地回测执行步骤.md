# 方案D-Stage1 本地回测执行步骤

**当前状态**: ✅ 服务器配置已完成并同步到Git
**下一步**: 在你的Mac上执行回测

---

## 📋 执行清单

### ✅ 第1步：备份方案B结果（重要！）

```bash
# 打开终端，进入项目目录
cd ~/quant-trading

# 创建方案B备份目录
mkdir -p backtest_results/plan_b_30m

# 备份方案B的回测结果（这样方便后面对比）
cp backtest_results/multi_timeframe/30m/backtest_trades_BTC_USDT_30m.csv backtest_results/plan_b_30m/
cp backtest_results/multi_timeframe/30m/backtest_trades_ETH_USDT_30m.csv backtest_results/plan_b_30m/
cp backtest_results/multi_timeframe/30m/backtest_trades_SOL_USDT_30m.csv backtest_results/plan_b_30m/

# 确认备份成功
ls -lh backtest_results/plan_b_30m/
```

**预期输出**：应该看到3个CSV文件。

---

### ✅ 第2步：拉取最新配置

```bash
# 拉取服务器上的方案D-Stage1配置
git pull
```

**预期输出**：
```
Updating...
Fast-forward
 config/strategy_params.py  | XX +++---
 ...
```

---

### ✅ 第3步：验证配置

```bash
# 激活虚拟环境
source venv/bin/activate

# 运行验证脚本
python3 verify_plan_d_stage1.py
```

**预期输出**：
```
✅✅ 方案D-Stage1配置完全正确！可以开始回测。

方案B → 方案D-Stage1 参数变化
----------------------------------------
BTC min_signal_strength    60 → 55
BTC adx_threshold          30 → 25
ETH min_signal_strength    65 → 60
ETH adx_threshold          30 → 25
SOL min_signal_strength    60 → 55
SOL adx_threshold          30 → 25
```

**如果看到错误**：
- 检查是否成功 `git pull`
- 尝试 `git stash` 然后再 `git pull`
- 或告诉我具体错误信息

---

### ✅ 第4步：执行回测（重要！）

```bash
# 确保虚拟环境已激活（提示符前应该有 (venv)）
source venv/bin/activate

# 执行30m周期回测
python3 run_multi_timeframe_backtest.py
```

**预计耗时**：5-10分钟

**预期过程**：
```
🚀 开始多周期回测...
==========================================
回测配置:
- 品种: ['BTC/USDT', 'ETH/USDT', 'SOL/USDT']
- 周期: {'1h': ..., '30m': ..., '15m': ...}
==========================================

✅ BTC/USDT @ 1h 回测完成
✅ BTC/USDT @ 30m 回测完成
✅ BTC/USDT @ 15m 回测完成
...
```

**常见问题**：

1. **ModuleNotFoundError: No module named 'pandas'**
   ```bash
   pip3 install -r requirements.txt
   ```

2. **TA-Lib错误**
   ```bash
   brew install ta-lib
   pip3 install TA-Lib
   ```

3. **网络超时**
   - 回测需要从Binance拉取数据
   - 确保网络连接正常
   - 如果超时，等待1分钟后重试

---

### ✅ 第5步：快速查看结果

```bash
# 查看各品种的交易数（方案B是2、5、4，期望增加到5-6、7-8、6-8）
echo "=== BTC 交易数 ==="
grep "BUY" backtest_results/multi_timeframe/30m/backtest_trades_BTC_USDT_30m.csv | wc -l

echo "=== ETH 交易数 ==="
grep "BUY" backtest_results/multi_timeframe/30m/backtest_trades_ETH_USDT_30m.csv | wc -l

echo "=== SOL 交易数 ==="
grep "BUY" backtest_results/multi_timeframe/30m/backtest_trades_SOL_USDT_30m.csv | wc -l

# 查看信号强度分布（应该看到55-60的新信号）
echo "=== BTC 信号强度 ==="
grep "BUY" backtest_results/multi_timeframe/30m/backtest_trades_BTC_USDT_30m.csv | cut -d',' -f7 | sort -n

echo "=== ETH 信号强度 ==="
grep "BUY" backtest_results/multi_timeframe/30m/backtest_trades_ETH_USDT_30m.csv | cut -d',' -f7 | sort -n

echo "=== SOL 信号强度 ==="
grep "BUY" backtest_results/multi_timeframe/30m/backtest_trades_SOL_USDT_30m.csv | cut -d',' -f7 | sort -n
```

**期望看到**：
- BTC: 5-6笔交易，信号强度包含55-60
- ETH: 7-8笔交易，信号强度包含60-64
- SOL: 6-8笔交易，信号强度包含55-59

---

### ✅ 第6步：提交结果到服务器

```bash
# 查看修改的文件
git status

# 添加回测结果
git add backtest_results/

# 提交（包含交易数和收益信息）
git commit -m "方案D-Stage1回测完成

交易数变化:
- BTC: 2笔 → X笔
- ETH: 5笔 → X笔
- SOL: 4笔 → X笔
- 总计: 11笔 → X笔

收益变化:
- BTC: -3.37% → X%
- ETH: -0.31% → X%
- SOL: +8.21% → X%
- 总计: +4.52% → X%"

# 推送到服务器
git push
```

**替换X为实际数字**（从第5步的输出获取）

---

## 📊 成功标准提醒

### 最低标准（必须达到）：
- ✅ **总交易数 ≥14笔**（vs 方案B的11笔）
- ✅ **总收益 ≥+4.5%**（vs 方案B的+4.52%）
- ✅ **胜率 ≥30%**（vs 方案B的36%，允许略降）

### 理想标准（期望达到）：
- 🌟 **总交易数 ≥18笔**（+64%）
- 🌟 **总收益 ≥+6%**（+33%）
- 🌟 **BTC改善**：收益 > -2% 或交易数 ≥5笔
- 🌟 **ETH盈利**：收益 > 0%

---

## ⚠️ 如果遇到问题

### 问题1：git pull冲突
```bash
git stash
git pull
git stash pop
```

### 问题2：依赖安装失败
```bash
# 删除虚拟环境重建
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip3 install -r requirements.txt
```

### 问题3：回测运行失败
- 检查错误信息
- 确保网络连接正常
- 查看 LOCAL_BACKTEST_GUIDE.md
- 或直接告诉我错误信息

---

## ✅ 完成后

提交到Git后，告诉我：

**"方案D-Stage1回测完成"**

我会立即：
1. 拉取你的回测结果
2. 详细分析对比方案B
3. 判断是否达到成功标准
4. 决定下一步方向（Stage2、实盘、或调整）

---

## 🎯 预期结果（理想情况）

如果一切顺利，你应该看到：

```
方案B基准：
- 总交易: 11笔
- 总收益: +4.52%
- BTC: 2笔, -3.37%
- ETH: 5笔, -0.31%
- SOL: 4笔, +8.21%

方案D-Stage1：
- 总交易: 18-22笔 ✅
- 总收益: +6~9% ✅
- BTC: 5-6笔, -1~+1% ✅
- ETH: 7-8笔, +1~+3% ✅
- SOL: 6-8笔, +6~+10% ✅
```

---

**准备好了吗？从第1步开始执行吧！** 🚀

有任何问题随时告诉我！
