# 方案A + 多时间周期回测指南

**更新时间**: 2025-10-28
**配置版本**: 方案A（保守优化）
**支持周期**: 15m、30m、1h

---

## 📋 方案A 参数调整

### 核心优化

基于 v4.0 的分析结果，采用保守优化方案：

#### 1. 趋势策略参数

| 参数 | v4.0 原值 | 方案A | 调整说明 |
|------|----------|-------|---------|
| 止损 | 3.5% | **3%** | 收紧止损，更及时止损 |
| 止盈 | 7% | **5%** | 降低目标，更现实可达 |
| 持仓时间 | 96h | **60h** | 缩短持仓，减少风险暴露 |

#### 2. 品种差异化参数

| 品种 | 止损 | 止盈 | 信号阈值 | 说明 |
|------|------|------|---------|------|
| BTC/USDT | 3% | 5% | 65 | 从4%/8%收紧 |
| ETH/USDT | 3% | 5% | 65 | 从4%/8%收紧 |
| SOL/USDT | 2.5% | 4.5% | 60 | 从3.5%/7%收紧，阈值提高 |

### 优化逻辑

1. **降低止盈目标** → 提高盈利交易的成功率
2. **收紧止损** → 防止单笔大额亏损
3. **缩短持仓** → 适应震荡市，快进快出
4. **提高SOL阈值** → 减少低质量交易（60 vs 原55）

---

## 🚀 多时间周期回测

### 为什么需要多周期测试？

不同时间周期适合不同的交易风格：

- **15m**（15分钟）
  - 优点：交易机会多，快速反应
  - 缺点：噪音大，需要频繁监控
  - 适合：短线交易者

- **30m**（30分钟）
  - 优点：平衡型，过滤部分噪音
  - 缺点：需要一定的盯盘时间
  - 适合：日内交易者

- **1h**（1小时）
  - 优点：趋势更清晰，交易频率适中
  - 缺点：反应较慢
  - 适合：趋势跟随者（原策略）

### 数据量配置

所有周期统一使用 **60天** 数据：

| 周期 | K线数量 | 说明 |
|------|---------|------|
| 15m | 5,960根 | 60天 × 96根/天 + 200预热 |
| 30m | 3,080根 | 60天 × 48根/天 + 200预热 |
| 1h | 1,640根 | 60天 × 24根/天 + 200预热 |

---

## 🔧 使用步骤

### 在本地 Mac 执行

#### 步骤 1: 同步最新代码

```bash
cd /Volumes/datedisk\ 1/code/quant-trading
git pull
```

你会获得：
- ✅ 方案A优化后的参数配置
- ✅ 多时间周期回测脚本
- ✅ 多周期分析工具

#### 步骤 2: 运行多时间周期回测

```bash
# 清理缓存（重要！）
./cleanup.sh

# 运行多周期回测（15m、30m、1h）
python3 run_multi_timeframe_backtest.py
```

**预计耗时**：10-20 分钟（取决于网络速度）

回测过程：
1. 15m 周期：BTC、ETH、SOL（约5,960根K线/品种）
2. 30m 周期：BTC、ETH、SOL（约3,080根K线/品种）
3. 1h 周期：BTC、ETH、SOL（约1,640根K线/品种）

结果自动保存到：
```
backtest_results/multi_timeframe/
├── 15m/
│   ├── backtest_trades_BTC_USDT_15m.csv
│   ├── backtest_trades_ETH_USDT_15m.csv
│   └── backtest_trades_SOL_USDT_15m.csv
├── 30m/
│   └── ...
├── 1h/
│   └── ...
└── metadata.json
```

#### 步骤 3: 分析对比结果

```bash
# 运行多周期分析
python3 analyze_multi_timeframe.py
```

会显示：
- 各品种在不同周期的表现对比
- 整体组合表现对比
- 推荐的最佳时间周期
- 综合评分

#### 步骤 4: 查看具体数据

```bash
# 查看某个周期的详细结果
python3 analyze_backtest_v2.py  # 会提示选择目录

# 或者直接查看CSV
head -20 backtest_results/multi_timeframe/1h/backtest_trades_BTC_USDT_1h.csv
```

#### 步骤 5: 提交结果

```bash
# 保存多周期测试结果
git add backtest_results/multi_timeframe/
git add config/strategy_params.py

git commit -m "Backtest results: Plan A with multi-timeframe (15m/30m/1h)

方案A参数（保守优化）：
- 止损：BTC/ETH 3%, SOL 2.5%
- 止盈：BTC/ETH 5%, SOL 4.5%
- 持仓时间：60小时

多时间周期测试：
- 15m: [填写结果]
- 30m: [填写结果]
- 1h: [填写结果]

最佳周期: [根据分析结果填写]"

git push
```

---

## 📊 预期结果对比

### v4.0 vs 方案A 预期改善

| 指标 | v4.0 | 方案A预期 | 改善 |
|------|------|----------|------|
| 总收益率 | -8.88% | 0~+3% | +9~12% |
| 平均胜率 | 35% | 40~45% | +5~10% |
| 盈亏比 | <1 | >1 | 改善 |
| 单笔最大亏损 | -10.6% | <-5% | 降低风险 |

### 不同周期预期特点

| 周期 | 交易频率 | 预期胜率 | 预期收益 | 适合人群 |
|------|---------|---------|---------|---------|
| 15m | 高（30-50次） | 35-40% | -2~+5% | 短线高手 |
| 30m | 中（15-25次） | 38-43% | 0~+6% | 日内交易者 |
| 1h | 低（8-15次） | 40-45% | +1~+7% | 趋势跟随者 |

---

## 🔍 分析重点

### 1. 信号质量验证

```bash
# 检查各周期的信号强度
for tf in 15m 30m 1h; do
    echo "=== $tf 周期 ==="
    grep "BUY" backtest_results/multi_timeframe/$tf/backtest_trades_BTC_USDT_$tf.csv | \
        cut -d',' -f7 | sort -n
done
```

**应该看到**：
- BTC/ETH：全部 ≥ 65
- SOL：全部 ≥ 60（提高了！）

### 2. 止损/止盈有效性

检查：
- 单笔最大亏损是否控制在止损范围内
- 盈利交易是否更容易达到新的止盈目标（5%/4.5%）

### 3. 持仓时间分布

```bash
# 在分析结果中查看平均持仓时间
# 应该更短（相比v4.0的60-70小时）
```

---

## 💡 优化建议

### 如果结果仍不理想

#### 选项 1: 微调止损/止盈
```python
# 进一步降低止盈
"take_profit_pct": 0.04,  # 4%

# 或者进一步收紧止损
"stop_loss_pct": 0.025,   # 2.5%
```

#### 选项 2: 调整信号阈值
```python
# BTC/ETH 降低阈值，增加交易机会
"min_signal_strength": 60,  # 从65降至60

# SOL 进一步提高阈值
"min_signal_strength": 65,  # 从60提高到65
```

#### 选项 3: 选择表现最好的时间周期
- 根据多周期测试结果
- 专注于最佳周期
- 针对性优化参数

---

## 📈 成功标准

### 最低目标（可接受）

- 总收益率 > 0%
- 平均胜率 > 40%
- 盈亏比 > 1.0
- 最大回撤 < 15%

### 理想目标

- 总收益率 > +5%
- 平均胜率 > 45%
- 盈亏比 > 1.2
- 最大回撤 < 10%

### 优秀目标

- 总收益率 > +10%
- 平均胜率 > 50%
- 盈亏比 > 1.5
- 最大回撤 < 8%

---

## 🎯 决策树

```
运行多周期回测
    ↓
分析结果
    ↓
├─ 如果某个周期达到"理想目标"
│   → ✅ 采用该周期参数
│   → 进行更长期测试（90天）
│   → 考虑实盘小资金测试
│
├─ 如果某个周期达到"最低目标"
│   → ⚠️  可以接受，但需继续优化
│   → 尝试微调参数
│   → 测试其他技术指标
│
└─ 如果所有周期都未达标
    → ❌ 重新审视策略
    → 考虑其他策略方向
    → 或者更换市场环境（牛市/熊市）
```

---

## 📝 常见问题

### Q1: 为什么要测试多个时间周期？

A: 不同时间周期捕捉不同的价格波动特征。某些策略在短周期表现好，某些在长周期表现好。通过测试找到最适合当前策略的周期。

### Q2: 15m数据量很大，下载会不会很慢？

A: 会比较慢（10-15分钟），但只需要运行一次。建议在网络良好时进行。

### Q3: 如果三个周期结果都差不多怎么办？

A: 优先选择1h周期，因为：
- 信号更可靠（噪音少）
- 监控成本低
- 适合趋势跟随策略

### Q4: 可以只测试一个品种的多周期吗？

A: 可以，修改 `run_multi_timeframe_backtest.py` 中的 `symbols` 列表：
```python
symbols = ['BTC/USDT']  # 只测试BTC
```

---

## 🔄 迭代优化流程

1. **第一轮**：运行多周期回测，找到最佳周期
2. **第二轮**：针对最佳周期微调参数
3. **第三轮**：延长回测时间（90-120天）验证稳定性
4. **第四轮**：在最佳参数下进行实盘测试

---

**创建时间**: 2025-10-28
**适用版本**: 方案A（保守优化）+ 多时间周期
**下次更新**: 多周期回测完成后
