# 方案D-Stage2 本地回测执行步骤

**当前状态**: ✅ 服务器Stage2配置已完成并推送到Git
**下一步**: 在你的Mac上执行Stage2回测

---

## 📋 执行清单

### ✅ 第1步：备份Stage1结果（重要！）

```bash
# 打开终端，进入项目目录
cd ~/quant-trading

# 创建Stage1备份目录
mkdir -p backtest_results/stage1_30m

# 备份Stage1的回测结果（这样方便后面对比）
cp backtest_results/multi_timeframe/30m/backtest_trades_BTC_USDT_30m.csv backtest_results/stage1_30m/
cp backtest_results/multi_timeframe/30m/backtest_trades_ETH_USDT_30m.csv backtest_results/stage1_30m/
cp backtest_results/multi_timeframe/30m/backtest_trades_SOL_USDT_30m.csv backtest_results/stage1_30m/

# 确认备份成功
ls -lh backtest_results/stage1_30m/
```

**预期输出**：应该看到3个CSV文件。

---

### ✅ 第2步：拉取Stage2配置

```bash
# 拉取服务器上的方案D-Stage2配置
git pull
```

**预期输出**：
```
Updating...
Fast-forward
 strategy_engine.py         | XX +++---
 config/strategy_params.py  | XX +++---
 verify_plan_d_stage2.py    | (new file)
 compare_stage1_vs_stage2.py| (new file)
 ...
```

---

### ✅ 第3步：验证Stage2配置

```bash
# 激活虚拟环境
source venv/bin/activate

# 运行Stage2验证脚本
python3 verify_plan_d_stage2.py
```

**预期输出**：
```
✅✅ Stage2量价背离分级逻辑实现正确！可以开始回测。

检查 strategy_engine.py 中的关键实现：
  ✅ 找到: 'obv_gap_pct'
  ✅ 找到: 'penalty = 30'
  ✅ 找到: 'penalty = 20'
  ✅ 找到: 'penalty = 10'
  ✅ 找到: 'penalty = 5'
  ...
```

**如果看到错误**：
- 检查是否成功 `git pull`
- 尝试 `git stash` 然后再 `git pull`
- 或告诉我具体错误信息

---

### ✅ 第4步：执行回测（重要！）

```bash
# 确保虚拟环境已激活（提示符前应该有 (venv)）
source venv/bin/activate

# 执行30m周期回测
python3 run_multi_timeframe_backtest.py
```

**预计耗时**：5-10分钟

**预期过程**：
```
🚀 开始多周期回测...
==========================================
回测配置:
- 品种: ['BTC/USDT', 'ETH/USDT', 'SOL/USDT']
- 周期: {'1h': ..., '30m': ..., '15m': ...}
==========================================

✅ BTC/USDT @ 1h 回测完成
✅ BTC/USDT @ 30m 回测完成
✅ BTC/USDT @ 15m 回测完成
...
```

**常见问题**：

1. **ModuleNotFoundError: No module named 'pandas'**
   ```bash
   pip3 install -r requirements.txt
   ```

2. **TA-Lib错误**
   ```bash
   brew install ta-lib
   pip3 install TA-Lib
   ```

3. **网络超时**
   - 回测需要从Binance拉取数据
   - 确保网络连接正常
   - 如果超时，等待1分钟后重试

---

### ✅ 第5步：快速查看Stage2结果

```bash
# 查看各品种的交易数（Stage1是2、5、5，期望增加到13-15笔总计）
echo "=== Stage1 vs Stage2 交易数对比 ==="
echo "BTC Stage1:"
grep "BUY" backtest_results/stage1_30m/backtest_trades_BTC_USDT_30m.csv | wc -l
echo "BTC Stage2:"
grep "BUY" backtest_results/multi_timeframe/30m/backtest_trades_BTC_USDT_30m.csv | wc -l

echo "ETH Stage1:"
grep "BUY" backtest_results/stage1_30m/backtest_trades_ETH_USDT_30m.csv | wc -l
echo "ETH Stage2:"
grep "BUY" backtest_results/multi_timeframe/30m/backtest_trades_ETH_USDT_30m.csv | wc -l

echo "SOL Stage1:"
grep "BUY" backtest_results/stage1_30m/backtest_trades_SOL_USDT_30m.csv | wc -l
echo "SOL Stage2:"
grep "BUY" backtest_results/multi_timeframe/30m/backtest_trades_SOL_USDT_30m.csv | wc -l

# 查看量价背离分级标记（Stage2核心改进）
echo ""
echo "=== 量价背离分级信号 ==="
grep "背离" backtest_results/multi_timeframe/30m/backtest_trades_*_30m.csv | head -20
```

**期望看到**：
- 总交易数：12笔（Stage1）→ 13-15笔（Stage2）
- 背离标记中出现：⚠️⚠️ 严重背离、⚠️ 中度背离、⚠️ 轻微背离、微弱背离
- 轻微背离(2-5%)的信号通过了过滤阈值

---

### ✅ 第6步：运行自动化对比工具

```bash
# 运行Stage1 vs Stage2对比分析
python3 compare_stage1_vs_stage2.py
```

**预期输出**：
- Stage1和Stage2的详细对比
- 量价背离分级信号分析
- 是否达到预期目标的判断

---

### ✅ 第7步：提交Stage2结果到服务器

```bash
# 查看修改的文件
git status

# 添加回测结果和备份
git add backtest_results/

# 提交（包含Stage1 vs Stage2对比信息）
git commit -m "方案D-Stage2回测完成：量价背离分级

Stage1→Stage2变化:
- 总交易数: 12笔 → X笔
- 总收益: +5.66% → X%

分品种:
- BTC: 2笔/-3.37% → X笔/X%
- ETH: 5笔/+0.55% → X笔/X%
- SOL: 5笔/+8.49% → X笔/X%

量价背离分级效果:
- 新增轻微背离信号: X笔
- 收益改善: X%"

# 推送到服务器
git push
```

**替换X为实际数字**（从第6步的对比工具输出获取）

---

## 📊 Stage2成功标准

### 最低标准（必须达到）：
- ✅ **总交易数 ≥13笔**（vs Stage1的12笔）
- ✅ **总收益 ≥+5.66%**（vs Stage1的+5.66%，至少保持）
- ✅ **胜率 ≥33%**（允许略降）

### 理想标准（期望达到）：
- 🌟 **总交易数 ≥14笔**（+17%）
- 🌟 **总收益 ≥+6.5%**（+15%）
- 🌟 **新增轻微背离信号**：1-3笔通过过滤
- 🌟 **收益质量提升**：新增交易盈利

---

## ⚠️ 如果遇到问题

### 问题1：git pull冲突
```bash
git stash
git pull
git stash pop
```

### 问题2：依赖安装失败
```bash
# 删除虚拟环境重建
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip3 install -r requirements.txt
```

### 问题3：回测运行失败
- 检查错误信息
- 确保网络连接正常
- 查看 LOCAL_BACKTEST_GUIDE.md
- 或直接告诉我错误信息

---

## ✅ 完成后

提交到Git后，告诉我：

**"方案D-Stage2回测完成"**

我会立即：
1. 拉取你的Stage2回测结果
2. 运行详细对比分析（Stage1 vs Stage2）
3. 判断是否达到成功标准
4. 决定下一步方向：
   - Stage2成功 → 考虑Stage3或实盘验证
   - Stage2部分成功 → 调整参数或直接实盘
   - Stage2不理想 → 回退Stage1或尝试其他方案

---

## 🎯 Stage2预期效果（理想情况）

如果一切顺利，你应该看到：

```
Stage1基准（已实现）：
- 总交易: 12笔
- 总收益: +5.66%
- BTC: 2笔, -3.37%
- ETH: 5笔, +0.55%
- SOL: 5笔, +8.49%
- 胜率: 33.3%

Stage2预期（量价背离分级）：
- 总交易: 13-15笔 ✅ (+8-25%)
- 总收益: +6.5~7% ✅ (+15-24%)
- BTC: 2-3笔, -3~-2% (略有改善)
- ETH: 5-6笔, +0.5~+2% (保持或改善)
- SOL: 6-7笔, +9~+11% (持续改善)
- 胜率: ≥33% (保持)

核心改进机制：
- 轻微背离(2-5%) 从 -30分 → -10分
- 允许优质信号通过：75-10=65 ≥ 60阈值
- 严重背离(>10%) 仍被过滤：75-30=45 < 60阈值
```

---

## 📝 Stage2关键改进说明

**量价背离分级惩罚系统**：

| 背离程度 | OBV差距 | Stage1惩罚 | Stage2惩罚 | 改善 |
|---------|---------|-----------|-----------|------|
| 严重背离 | >10% | -30分 | -30分 | 无变化（保持严格） |
| 中度背离 | 5-10% | -30分 | -20分 | 放宽10分 |
| 轻微背离 | 2-5% | -30分 | -10分 | **放宽20分** ⭐ |
| 微弱背离 | ≤2% | -30分 | -5分 | 放宽25分 |

**预期新增交易示例**：
- 信号强度75 + 轻微背离3%: Stage1: 75-30=45❌ → Stage2: 75-10=65✅
- 信号强度70 + 微弱背离1%: Stage1: 70-30=40❌ → Stage2: 70-5=65✅

---

**准备好了吗？从第1步开始执行Stage2回测吧！** 🚀

有任何问题随时告诉我！
