<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡åŒ–äº¤æ˜“ç›‘æ§Dashboard</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* æš—é»‘æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ */
        body {
            background-color: #0f0f23;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* æ˜äº®æ¨¡å¼ */
        body.light-mode {
            background-color: #f5f5f5;
            color: #333333;
        }

        body.light-mode .card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
        }

        body.light-mode .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            color: #333333;
        }

        body.light-mode .table-dark {
            background-color: #ffffff;
        }

        body.light-mode .table-dark td,
        body.light-mode .table-dark th {
            border-color: #e0e0e0;
            color: #333333;
        }

        body.light-mode .table-dark thead th {
            background-color: #f8f9fa;
            border-color: #e0e0e0;
        }

        body.light-mode .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }

        body.light-mode .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
        }

        body.light-mode .news-item {
            border-bottom: 1px solid #e0e0e0;
        }

        body.light-mode .news-item:hover {
            background-color: #f8f9fa;
        }

        body.light-mode .text-muted {
            color: #6c757d !important;
        }

        body.light-mode .alert-box {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }

        /* æ˜äº®æ¨¡å¼ä¸‹çš„å¾½ç« é¢œè‰²ä¼˜åŒ– */
        body.light-mode .badge {
            font-weight: 600;
        }

        body.light-mode .badge.bg-success {
            background-color: #198754 !important;
            color: #ffffff !important;
        }

        body.light-mode .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #000000 !important;
        }

        body.light-mode .badge.bg-danger {
            background-color: #dc3545 !important;
            color: #ffffff !important;
        }

        body.light-mode .badge.bg-secondary {
            background-color: #6c757d !important;
            color: #ffffff !important;
        }

        /* æ˜äº®æ¨¡å¼ä¸‹çš„æ­£è´Ÿå€¼é¢œè‰²ä¼˜åŒ– */
        body.light-mode .positive {
            color: #198754 !important;
            font-weight: 600;
        }

        body.light-mode .negative {
            color: #dc3545 !important;
            font-weight: 600;
        }

        body.light-mode .neutral {
            color: #6c757d !important;
        }

        /* æ˜äº®æ¨¡å¼ä¸‹çš„è¡¨æ ¼è¡Œå¼ºåŒ– */
        body.light-mode .table-dark tbody tr {
            border-bottom: 1px solid #dee2e6;
        }

        body.light-mode .table-dark tbody tr:hover {
            background-color: #e9ecef !important;
        }

        /* æ˜äº®æ¨¡å¼ä¸‹çš„å¡ç‰‡å¤´éƒ¨å¼ºåŒ– */
        body.light-mode .card-header {
            font-weight: 600;
            background-color: #e9ecef;
        }

        /* æ˜äº®æ¨¡å¼ä¸‹çš„æŒ‰é’® */
        body.light-mode .refresh-btn,
        body.light-mode .theme-toggle-btn {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* æ˜äº®æ¨¡å¼ä¸‹çš„æ–°é—»é¡¹ */
        body.light-mode .news-item {
            border-bottom: 1px solid #dee2e6;
        }

        body.light-mode .news-item:hover {
            background-color: #e9ecef;
        }

        /* æ˜äº®æ¨¡å¼ä¸‹é“¾æ¥é¢œè‰² */
        body.light-mode a {
            color: #0d6efd;
        }

        body.light-mode a:hover {
            color: #0a58ca;
        }

        /* æ˜äº®æ¨¡å¼ä¸‹çš„æŒ‡æ ‡å¡ç‰‡ */
        body.light-mode .metric-card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
        }

        body.light-mode .metric-value {
            color: #333333;
        }

        body.light-mode .metric-label {
            color: #6c757d;
        }

        /* æ˜äº®æ¨¡å¼ä¸‹è¡¨æ ¼å¤´éƒ¨åŠ ç²— */
        body.light-mode .table-dark thead th {
            font-weight: 600;
            color: #495057;
        }

        /* æ˜äº®æ¨¡å¼ä¸‹çš„å¼ºä¿¡å·çªå‡ºæ˜¾ç¤º */
        body.light-mode .table-dark tbody td strong {
            color: #212529;
        }

        body.light-mode .table-dark tbody td small {
            color: #6c757d;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .card {
            background-color: #1a1a2e;
            border: 1px solid #2d2d44;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .card-header {
            background-color: #16213e;
            border-bottom: 1px solid #2d2d44;
            font-weight: 600;
        }

        .metric-card {
            text-align: center;
            padding: 20px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-label {
            color: #8a8a8a;
            font-size: 0.9rem;
        }

        .positive {
            color: #00d4aa;
        }

        .negative {
            color: #ff4757;
        }

        .neutral {
            color: #ffa502;
        }

        .signal-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .news-item {
            padding: 12px;
            border-bottom: 1px solid #2d2d44;
            transition: background-color 0.2s;
        }

        .news-item:hover {
            background-color: #252540;
        }

        .alert-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .alert-critical {
            background-color: #ff475733;
            border-left: 4px solid #ff4757;
        }

        .alert-warning {
            background-color: #ffa50233;
            border-left: 4px solid #ffa502;
        }

        .alert-info {
            background-color: #2ed57333;
            border-left: 4px solid #2ed573;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online {
            background-color: #2ed573;
            box-shadow: 0 0 8px #2ed573;
        }

        .status-offline {
            background-color: #ff4757;
        }

        .table-dark {
            background-color: #1a1a2e;
        }

        .table-dark td, .table-dark th {
            border-color: #2d2d44;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 1000;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .refresh-btn.loading i {
            animation: spin 1s linear infinite;
        }

        .theme-toggle-btn {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 1000;
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid px-4">
        <!-- Header -->
        <div class="dashboard-header mt-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0">
                        <i class="bi bi-graph-up"></i> é‡åŒ–äº¤æ˜“ç›‘æ§ç³»ç»Ÿ
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">
                        å®æ—¶ç›‘æ§ â€¢ æ™ºèƒ½åˆ†æ â€¢ ç²¾å‡†å†³ç­–
                    </p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="mb-2">
                        <span class="status-indicator status-online"></span>
                        <span>å®æ—¶è¿æ¥</span>
                    </div>
                    <small id="updateTime">{{ update_time }}</small>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦æŒ‡æ ‡æ¦‚è§ˆ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-label">æ´»è·ƒä¿¡å·</div>
                    <div class="metric-value positive" id="activeSignals">0</div>
                    <small class="text-muted">ä¸ªäº¤æ˜“æœºä¼š</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-label">ç›‘æ§å¸ç§</div>
                    <div class="metric-value neutral" id="activeSymbols">{{ symbols|length }}</div>
                    <small class="text-muted">ä¸ªäº¤æ˜“å¯¹</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-label">æ–°é—»äº‹ä»¶</div>
                    <div class="metric-value" id="newsCount">0</div>
                    <small class="text-muted">æ¡æœ€æ–°æ¶ˆæ¯</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-label">å¸‚åœºæƒ…ç»ª</div>
                    <div class="metric-value neutral" id="marketSentiment">ä¸­æ€§</div>
                    <small class="text-muted" id="sentimentScore">0åˆ†</small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- å·¦ä¾§ï¼šäº¤æ˜“ä¿¡å·å’Œå¸‚åœºæ•°æ® -->
            <div class="col-md-8">
                <!-- å‘Šè­¦åŒºåŸŸ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-exclamation-triangle"></i> é‡è¦å‘Šè­¦
                    </div>
                    <div class="card-body" id="alertsContainer">
                        <div class="text-muted text-center py-3">
                            æš‚æ— å‘Šè­¦
                        </div>
                    </div>
                </div>

                <!-- å®æ—¶äº¤æ˜“ä¿¡å· -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-activity"></i> å®æ—¶äº¤æ˜“ä¿¡å·
                        <small class="text-muted ms-2">æ‰€æœ‰å¸ç§çš„ä¿¡å·å¼ºåº¦å’Œæ–¹å‘</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>å¸ç§</th>
                                        <th>å½“å‰ä»·æ ¼</th>
                                        <th>ä¿¡å·å¼ºåº¦</th>
                                        <th>æ–¹å‘</th>
                                        <th>æƒ…ç»ªå¾—åˆ†</th>
                                        <th>èµ„é‡‘è´¹ç‡</th>
                                    </tr>
                                </thead>
                                <tbody id="signalsTable">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            åŠ è½½ä¸­...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- å¼€ä»“æœºä¼šå»ºè®® -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-compass"></i> å¼€ä»“æœºä¼šå»ºè®®
                        <small class="text-muted ms-2">ä»…æ˜¾ç¤ºæœ‰æ˜ç¡®äº¤æ˜“ä¿¡å·æ—¶</small>
                    </div>
                    <div class="card-body" id="opportunitiesContainer">
                        <div class="text-muted text-center py-3">
                            å½“å‰æ— æ˜ç¡®å¼€ä»“æœºä¼šï¼Œå¸‚åœºå¤„äºè§‚æœ›çŠ¶æ€
                        </div>
                    </div>
                </div>

                <!-- å¸‚åœºæ¦‚è§ˆ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-bar-chart"></i> å¸‚åœºæ¦‚è§ˆ
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“å¯¹</th>
                                        <th>ä»·æ ¼</th>
                                        <th>èµ„é‡‘è´¹ç‡</th>
                                        <th>æŒä»“é‡</th>
                                        <th>æ•°æ®æº</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="marketTable">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            åŠ è½½ä¸­...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ–°é—»å’Œæƒ…ç»ª -->
            <div class="col-md-4">
                <!-- é²¸é±¼åŠ¨æ€ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-tsunami"></i> é²¸é±¼åŠ¨æ€
                    </div>
                    <div class="card-body" id="whaleAlertsContainer">
                        <div class="text-muted text-center py-3">
                            æš‚æ— å¤§é¢äº¤æ˜“
                        </div>
                    </div>
                </div>

                <!-- æ–°é—»èµ„è®¯ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-newspaper"></i> æœ€æ–°èµ„è®¯
                    </div>
                    <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                        <div id="newsContainer">
                            <div class="text-muted text-center py-3">
                                åŠ è½½ä¸­...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æƒ…ç»ªåˆ†æ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-emoji-smile"></i> æƒ…ç»ªåˆ†æ
                    </div>
                    <div class="card-body">
                        <canvas id="sentimentChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <button class="refresh-btn" id="refreshBtn" onclick="refreshAll()">
        <i class="bi bi-arrow-clockwise"></i>
    </button>

    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle-btn" id="themeToggleBtn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
        <i class="bi bi-sun-fill" id="themeIcon"></i>
    </button>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let sentimentChart = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initSentimentChart() {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            sentimentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æƒ…ç»ªå¾—åˆ†',
                        data: [],
                        backgroundColor: function(context) {
                            // å®‰å…¨æ£€æŸ¥ï¼Œé¿å…undefinedé”™è¯¯
                            if (!context.parsed) return '#8a8a8a';
                            const value = context.parsed.y;
                            return value > 0 ? '#00d4aa' : '#ff4757';
                        },
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#2d2d44' },
                            ticks: { color: '#8a8a8a' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#8a8a8a' }
                        }
                    }
                }
            });
        }

        // æ›´æ–°å¸‚åœºæ¦‚è§ˆ
        async function updateMarketOverview() {
            try {
                const response = await fetch('/api/market_overview');
                const result = await response.json();

                if (!result.success) {
                    console.error('API error:', result.error);
                    return;
                }

                const tbody = document.getElementById('marketTable');
                tbody.innerHTML = result.data.map(item => `
                    <tr>
                        <td><strong>${item.symbol}</strong></td>
                        <td>$${item.price.toFixed(2)}</td>
                        <td class="${item.funding_rate > 0 ? 'negative' : 'positive'}">
                            ${(item.funding_rate * 100).toFixed(4)}%
                        </td>
                        <td>$${item.open_interest.toLocaleString()}</td>
                        <td><span class="badge bg-secondary">${item.data_source}</span></td>
                        <td>
                            ${item.enabled ?
                                '<span class="badge bg-success">å¯ç”¨</span>' :
                                '<span class="badge bg-danger">ç¦ç”¨</span>'}
                        </td>
                    </tr>
                `).join('');

                // æ›´æ–°æ´»è·ƒå¸ç§æ•°
                const activeCount = result.data.filter(item => item.enabled).length;
                document.getElementById('activeSymbols').textContent = activeCount;

            } catch (error) {
                console.error('Failed to update market overview:', error);
            }
        }

        // æ›´æ–°äº¤æ˜“ä¿¡å·
        async function updateSignals() {
            try {
                const response = await fetch('/api/signals');
                const result = await response.json();

                if (!result.success) {
                    console.error('API error:', result.error);
                    return;
                }

                const tbody = document.getElementById('signalsTable');

                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">æš‚æ— ä¿¡å·</td></tr>';
                } else {
                    tbody.innerHTML = result.data.map(signal => {
                        // æ–¹å‘æ˜¾ç¤º
                        let typeIcon = 'â¸ï¸';
                        let typeBadgeClass = 'bg-warning';
                        let typeText = 'ä¸­æ€§';
                        if (signal.type === 'BULLISH') {
                            typeIcon = 'ğŸ“ˆ';
                            typeBadgeClass = 'bg-success';
                            typeText = 'çœ‹æ¶¨';
                        } else if (signal.type === 'BEARISH') {
                            typeIcon = 'ğŸ“‰';
                            typeBadgeClass = 'bg-danger';
                            typeText = 'çœ‹è·Œ';
                        }

                        // ä¿¡å·å¼ºåº¦é¢œè‰²
                        let strengthClass = 'neutral';
                        if (signal.strength >= 70) {
                            strengthClass = 'positive';
                        } else if (signal.strength < 55) {
                            strengthClass = 'negative';
                        }

                        return `
                            <tr>
                                <td><strong>${signal.symbol.replace('/USDT', '')}</strong></td>
                                <td>$${signal.price.toFixed(2)}</td>
                                <td><strong class="${strengthClass}">${signal.strength}</strong></td>
                                <td><span class="badge ${typeBadgeClass}">${typeIcon} ${typeText}</span></td>
                                <td class="${signal.sentiment > 0 ? 'positive' : signal.sentiment < 0 ? 'negative' : 'neutral'}">
                                    ${signal.sentiment > 0 ? '+' : ''}${signal.sentiment}
                                </td>
                                <td class="${signal.funding_rate > 0 ? 'negative' : signal.funding_rate < 0 ? 'positive' : 'neutral'}">
                                    ${(signal.funding_rate * 100).toFixed(4)}%
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                document.getElementById('activeSignals').textContent = result.data.length;

            } catch (error) {
                console.error('Failed to update signals:', error);
            }
        }

        // æ›´æ–°é‡è¦å‘Šè­¦
        async function updateAlerts() {
            try {
                const response = await fetch('/api/alerts');
                const result = await response.json();

                if (!result.success) {
                    console.error('API error:', result.error);
                    return;
                }

                const alertsContainer = document.getElementById('alertsContainer');

                if (result.count === 0) {
                    alertsContainer.innerHTML = '<div class="text-muted text-center py-3">æš‚æ— å‘Šè­¦</div>';
                } else {
                    alertsContainer.innerHTML = result.data.map(alert => {
                        let alertClass = 'alert-info';
                        let icon = 'bi-info-circle';
                        if (alert.type === 'warning') {
                            alertClass = 'alert-warning';
                            icon = 'bi-exclamation-triangle';
                        } else if (alert.type === 'critical') {
                            alertClass = 'alert-critical';
                            icon = 'bi-exclamation-octagon';
                        }

                        return `
                            <div class="alert-box ${alertClass}">
                                <strong>[${alert.symbol}]</strong> <i class="bi ${icon}"></i> ${alert.message}
                            </div>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.error('Failed to update alerts:', error);
            }
        }

        // æ›´æ–°å¼€ä»“æœºä¼šå»ºè®®
        async function updateTradingOpportunities() {
            try {
                const response = await fetch('/api/trading_opportunities');
                const result = await response.json();

                if (!result.success) {
                    console.error('API error:', result.error);
                    return;
                }

                const container = document.getElementById('opportunitiesContainer');

                if (result.data.length === 0) {
                    container.innerHTML = '<div class="text-muted text-center py-3">å½“å‰æ— æ˜ç¡®å¼€ä»“æœºä¼šï¼Œå¸‚åœºå¤„äºè§‚æœ›çŠ¶æ€</div>';
                } else {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>å¸ç§</th>
                                        <th>æ–¹å‘</th>
                                        <th>ç½®ä¿¡åº¦</th>
                                        <th>ä¿¡å·å¼ºåº¦</th>
                                        <th>å¼€ä»“ä»·</th>
                                        <th>æ­¢æŸ</th>
                                        <th>æ­¢ç›ˆ</th>
                                        <th>ç›ˆäºæ¯”</th>
                                        <th>èµ„é‡‘è´¹ç‡</th>
                                        <th>æƒ…ç»ª</th>
                                        <th>åŸå› </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.data.map(sug => {
                        // æ–¹å‘é¢œè‰²å’Œå›¾æ ‡
                        let actionClass = 'neutral';
                        let actionIcon = 'â¸ï¸';
                        if (sug.action === 'åšå¤š') {
                            actionClass = 'positive';
                            actionIcon = 'ğŸ“ˆ';
                        } else if (sug.action === 'åšç©º') {
                            actionClass = 'negative';
                            actionIcon = 'ğŸ“‰';
                        }

                        // ç½®ä¿¡åº¦å¾½ç« 
                        let confidenceBadge = '';
                        if (sug.confidence === 'high') {
                            confidenceBadge = '<span class="badge bg-success">é«˜</span>';
                        } else if (sug.confidence === 'medium') {
                            confidenceBadge = '<span class="badge bg-warning">ä¸­</span>';
                        } else {
                            confidenceBadge = '<span class="badge bg-secondary">ä½</span>';
                        }

                        // ä¿¡å·å¼ºåº¦é¢œè‰²
                        let strengthClass = 'neutral';
                        if (sug.strength >= 70) {
                            strengthClass = 'positive';
                        } else if (sug.strength >= 60) {
                            strengthClass = 'neutral';
                        } else {
                            strengthClass = 'negative';
                        }

                        // æ­¢ç›ˆæ­¢æŸæ˜¾ç¤º
                        const stopLossDisplay = sug.stop_loss ? `$${sug.stop_loss.toFixed(4)}` : '-';
                        const takeProfitDisplay = sug.take_profit ? `$${sug.take_profit.toFixed(4)}` : '-';
                        const rrRatioDisplay = sug.risk_reward_ratio ? `1:${sug.risk_reward_ratio}` : '-';

                        // èµ„é‡‘è´¹ç‡æ˜¾ç¤º
                        const fundingRateClass = sug.funding_rate > 0 ? 'negative' : sug.funding_rate < 0 ? 'positive' : 'neutral';
                        const fundingRateDisplay = (sug.funding_rate * 100).toFixed(4) + '%';

                        // æƒ…ç»ªæ˜¾ç¤º
                        const sentimentClass = sug.sentiment > 0 ? 'positive' : sug.sentiment < 0 ? 'negative' : 'neutral';
                        const sentimentDisplay = sug.sentiment > 0 ? `+${sug.sentiment}` : sug.sentiment;

                                        return `
                                            <tr>
                                                <td><strong>${sug.symbol.replace('/USDT', '')}</strong></td>
                                                <td><span class="${actionClass}">${actionIcon} ${sug.action}</span></td>
                                                <td>${confidenceBadge}</td>
                                                <td><strong class="${strengthClass}">${sug.strength}</strong></td>
                                                <td>$${sug.entry_price.toFixed(4)}</td>
                                                <td class="negative">${stopLossDisplay}</td>
                                                <td class="positive">${takeProfitDisplay}</td>
                                                <td>${rrRatioDisplay}</td>
                                                <td class="${fundingRateClass}">${fundingRateDisplay}</td>
                                                <td class="${sentimentClass}">${sentimentDisplay}</td>
                                                <td><small>${sug.reason}</small></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Failed to update trading suggestions:', error);
            }
        }

        // æ›´æ–°æ–°é—»
        async function updateNews() {
            try {
                const response = await fetch('/api/news');
                const result = await response.json();

                if (!result.success) {
                    console.error('API error:', result.error);
                    return;
                }

                const container = document.getElementById('newsContainer');

                if (result.count === 0) {
                    container.innerHTML = '<div class="text-muted text-center py-3">æš‚æ— æ–°é—»</div>';
                } else {
                    container.innerHTML = result.data.map(news => `
                        <div class="news-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <a href="${news.url || '#'}" target="_blank" class="text-decoration-none text-light">
                                        <strong>${news.title}</strong>
                                    </a>
                                    <div class="text-muted small mt-1">
                                        <i class="bi bi-clock"></i> ${news.published_at ? new Date(news.published_at).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                document.getElementById('newsCount').textContent = result.count;

            } catch (error) {
                console.error('Failed to update news:', error);
            }
        }

        // æ›´æ–°é²¸é±¼åŠ¨æ€
        async function updateWhaleAlerts() {
            try {
                const response = await fetch('/api/whale_alerts');
                const result = await response.json();

                if (!result.success) {
                    console.error('API error:', result.error);
                    return;
                }

                const container = document.getElementById('whaleAlertsContainer');

                if (result.count === 0) {
                    container.innerHTML = '<div class="text-muted text-center py-3">æš‚æ— å¤§é¢äº¤æ˜“</div>';
                } else {
                    container.innerHTML = result.data.map(tx => {
                        // ç±»å‹å›¾æ ‡å’Œæ ·å¼ï¼ˆå…œåº•å¤„ç†ï¼‰
                        const type = tx.type || 'transfer';
                        const typeIcon = type === 'buy' ? 'ğŸ“ˆ' : type === 'sell' ? 'ğŸ“‰' : 'ğŸ”„';
                        const typeClass = type === 'buy' ? 'positive' : type === 'sell' ? 'negative' : 'neutral';

                        // é‡‘é¢æ˜¾ç¤ºï¼ˆå…œåº•å¤„ç†ï¼‰
                        const valueUsd = tx.value_usd || 0;
                        const valueFormatted = (valueUsd / 1000000).toFixed(2);

                        // æè¿°ï¼ˆå…œåº•å¤„ç†ï¼‰
                        let description = tx.description;
                        if (!description || description === 'unknown') {
                            const typeText = type === 'buy' ? 'ä¹°å…¥' : type === 'sell' ? 'å–å‡º' : 'è½¬è´¦';
                            description = `${tx.symbol} é“¾ä¸Š${typeText}`;
                        }

                        return `
                            <div class="news-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div>
                                            ${typeIcon} <strong>${tx.symbol}</strong>
                                            <span class="${typeClass}">$${valueFormatted}M</span>
                                        </div>
                                        <div class="text-muted small mt-1">
                                            ${description}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.error('Failed to update whale alerts:', error);
            }
        }

        // æ›´æ–°æƒ…ç»ªåˆ†æ
        async function updateSentiment() {
            try {
                const symbols = {{ symbols | tojson }};
                const sentiments = [];

                for (const symbol of symbols.slice(0, 5)) {  // å‰5ä¸ªå¸ç§
                    // URLç¼–ç symbolå‚æ•°ï¼Œé¿å…è·¯å¾„åˆ†éš”ç¬¦é—®é¢˜
                    const encodedSymbol = encodeURIComponent(symbol);
                    const response = await fetch(`/api/sentiment/${encodedSymbol}`);
                    const result = await response.json();

                    if (result.success) {
                        sentiments.push({
                            symbol: symbol.replace('/USDT', ''),
                            score: result.data.total_score
                        });
                    }
                }

                // æ›´æ–°å›¾è¡¨
                if (sentimentChart) {
                    sentimentChart.data.labels = sentiments.map(s => s.symbol);
                    sentimentChart.data.datasets[0].data = sentiments.map(s => s.score);
                    sentimentChart.update();
                }

                // è®¡ç®—å¹³å‡æƒ…ç»ª
                const avgSentiment = sentiments.reduce((sum, s) => sum + s.score, 0) / sentiments.length;
                const sentimentText = avgSentiment > 10 ? 'ä¹è§‚' : avgSentiment < -10 ? 'æ‚²è§‚' : 'ä¸­æ€§';
                const sentimentClass = avgSentiment > 10 ? 'positive' : avgSentiment < -10 ? 'negative' : 'neutral';

                document.getElementById('marketSentiment').textContent = sentimentText;
                document.getElementById('marketSentiment').className = `metric-value ${sentimentClass}`;
                document.getElementById('sentimentScore').textContent = `${avgSentiment.toFixed(1)}åˆ†`;

            } catch (error) {
                console.error('Failed to update sentiment:', error);
            }
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAll() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('loading');

            try {
                await Promise.all([
                    updateMarketOverview(),
                    updateSignals(),  // å®æ—¶äº¤æ˜“ä¿¡å·
                    updateAlerts(),  // é‡è¦å‘Šè­¦
                    updateTradingOpportunities(),  // å¼€ä»“æœºä¼šå»ºè®®
                    updateNews(),
                    updateWhaleAlerts(),
                    updateSentiment()
                ]);

                document.getElementById('updateTime').textContent = new Date().toLocaleString('zh-CN');
            } finally {
                btn.classList.remove('loading');
            }
        }

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');

            if (body.classList.contains('light-mode')) {
                // åˆ‡æ¢åˆ°æš—é»‘æ¨¡å¼
                body.classList.remove('light-mode');
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
                localStorage.setItem('theme', 'dark');
            } else {
                // åˆ‡æ¢åˆ°æ˜äº®æ¨¡å¼
                body.classList.add('light-mode');
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
                localStorage.setItem('theme', 'light');
            }

            // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥é€‚åº”ä¸»é¢˜
            if (sentimentChart) {
                updateChartTheme();
            }
        }

        // æ›´æ–°å›¾è¡¨ä¸»é¢˜
        function updateChartTheme() {
            const isLight = document.body.classList.contains('light-mode');
            const gridColor = isLight ? '#e0e0e0' : '#2d2d44';
            const textColor = isLight ? '#333333' : '#8a8a8a';

            sentimentChart.options.scales.y.grid.color = gridColor;
            sentimentChart.options.scales.y.ticks.color = textColor;
            sentimentChart.options.scales.x.ticks.color = textColor;
            sentimentChart.update();
        }

        // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');

            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();  // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
            initSentimentChart();
            refreshAll();

            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(refreshAll, 30000);
        });
    </script>
</body>
</html>
