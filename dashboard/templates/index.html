<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡åŒ–äº¤æ˜“ç›‘æ§Dashboard</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        body {
            background-color: #0f0f23;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .card {
            background-color: #1a1a2e;
            border: 1px solid #2d2d44;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .card-header {
            background-color: #16213e;
            border-bottom: 1px solid #2d2d44;
            font-weight: 600;
        }

        .metric-card {
            text-align: center;
            padding: 20px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-label {
            color: #8a8a8a;
            font-size: 0.9rem;
        }

        .positive {
            color: #00d4aa;
        }

        .negative {
            color: #ff4757;
        }

        .neutral {
            color: #ffa502;
        }

        .signal-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .news-item {
            padding: 12px;
            border-bottom: 1px solid #2d2d44;
            transition: background-color 0.2s;
        }

        .news-item:hover {
            background-color: #252540;
        }

        .alert-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .alert-critical {
            background-color: #ff475733;
            border-left: 4px solid #ff4757;
        }

        .alert-warning {
            background-color: #ffa50233;
            border-left: 4px solid #ffa502;
        }

        .alert-info {
            background-color: #2ed57333;
            border-left: 4px solid #2ed573;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online {
            background-color: #2ed573;
            box-shadow: 0 0 8px #2ed573;
        }

        .status-offline {
            background-color: #ff4757;
        }

        .table-dark {
            background-color: #1a1a2e;
        }

        .table-dark td, .table-dark th {
            border-color: #2d2d44;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 1000;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .refresh-btn.loading i {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container-fluid px-4">
        <!-- Header -->
        <div class="dashboard-header mt-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0">
                        <i class="bi bi-graph-up"></i> é‡åŒ–äº¤æ˜“ç›‘æ§ç³»ç»Ÿ
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">
                        å®æ—¶ç›‘æ§ â€¢ æ™ºèƒ½åˆ†æ â€¢ ç²¾å‡†å†³ç­–
                    </p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="mb-2">
                        <span class="status-indicator status-online"></span>
                        <span>å®æ—¶è¿æ¥</span>
                    </div>
                    <small id="updateTime">{{ update_time }}</small>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦æŒ‡æ ‡æ¦‚è§ˆ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-label">æ´»è·ƒä¿¡å·</div>
                    <div class="metric-value positive" id="activeSignals">0</div>
                    <small class="text-muted">ä¸ªäº¤æ˜“æœºä¼š</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-label">ç›‘æ§å¸ç§</div>
                    <div class="metric-value neutral" id="activeSymbols">{{ symbols|length }}</div>
                    <small class="text-muted">ä¸ªäº¤æ˜“å¯¹</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-label">æ–°é—»äº‹ä»¶</div>
                    <div class="metric-value" id="newsCount">0</div>
                    <small class="text-muted">æ¡æœ€æ–°æ¶ˆæ¯</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-label">å¸‚åœºæƒ…ç»ª</div>
                    <div class="metric-value neutral" id="marketSentiment">ä¸­æ€§</div>
                    <small class="text-muted" id="sentimentScore">0åˆ†</small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- å·¦ä¾§ï¼šäº¤æ˜“ä¿¡å·å’Œå¸‚åœºæ•°æ® -->
            <div class="col-md-8">
                <!-- å‘Šè­¦åŒºåŸŸ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-exclamation-triangle"></i> é‡è¦å‘Šè­¦
                    </div>
                    <div class="card-body" id="alertsContainer">
                        <div class="text-muted text-center py-3">
                            æš‚æ— å‘Šè­¦
                        </div>
                    </div>
                </div>

                <!-- äº¤æ˜“ä¿¡å· -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-lightning"></i> å®æ—¶äº¤æ˜“ä¿¡å·
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>å¸ç§</th>
                                        <th>ä¿¡å·</th>
                                        <th>å¼ºåº¦</th>
                                        <th>ä»·æ ¼</th>
                                        <th>èµ„é‡‘è´¹ç‡</th>
                                        <th>æƒ…ç»ª</th>
                                        <th>æ—¶é—´</th>
                                    </tr>
                                </thead>
                                <tbody id="signalsTable">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            åŠ è½½ä¸­...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- å¸‚åœºæ¦‚è§ˆ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-bar-chart"></i> å¸‚åœºæ¦‚è§ˆ
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“å¯¹</th>
                                        <th>ä»·æ ¼</th>
                                        <th>èµ„é‡‘è´¹ç‡</th>
                                        <th>æŒä»“é‡</th>
                                        <th>æ•°æ®æº</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="marketTable">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            åŠ è½½ä¸­...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ–°é—»å’Œæƒ…ç»ª -->
            <div class="col-md-4">
                <!-- é²¸é±¼åŠ¨æ€ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-tsunami"></i> é²¸é±¼åŠ¨æ€
                    </div>
                    <div class="card-body" id="whaleAlertsContainer">
                        <div class="text-muted text-center py-3">
                            æš‚æ— å¤§é¢äº¤æ˜“
                        </div>
                    </div>
                </div>

                <!-- æ–°é—»èµ„è®¯ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-newspaper"></i> æœ€æ–°èµ„è®¯
                    </div>
                    <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                        <div id="newsContainer">
                            <div class="text-muted text-center py-3">
                                åŠ è½½ä¸­...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æƒ…ç»ªåˆ†æ -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-emoji-smile"></i> æƒ…ç»ªåˆ†æ
                    </div>
                    <div class="card-body">
                        <canvas id="sentimentChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <button class="refresh-btn" id="refreshBtn" onclick="refreshAll()">
        <i class="bi bi-arrow-clockwise"></i>
    </button>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let sentimentChart = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initSentimentChart() {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            sentimentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æƒ…ç»ªå¾—åˆ†',
                        data: [],
                        backgroundColor: function(context) {
                            // å®‰å…¨æ£€æŸ¥ï¼Œé¿å…undefinedé”™è¯¯
                            if (!context.parsed) return '#8a8a8a';
                            const value = context.parsed.y;
                            return value > 0 ? '#00d4aa' : '#ff4757';
                        },
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#2d2d44' },
                            ticks: { color: '#8a8a8a' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#8a8a8a' }
                        }
                    }
                }
            });
        }

        // æ›´æ–°å¸‚åœºæ¦‚è§ˆ
        async function updateMarketOverview() {
            try {
                const response = await fetch('/api/market_overview');
                const result = await response.json();

                if (!result.success) {
                    console.error('API error:', result.error);
                    return;
                }

                const tbody = document.getElementById('marketTable');
                tbody.innerHTML = result.data.map(item => `
                    <tr>
                        <td><strong>${item.symbol}</strong></td>
                        <td>$${item.price.toFixed(2)}</td>
                        <td class="${item.funding_rate > 0 ? 'negative' : 'positive'}">
                            ${(item.funding_rate * 100).toFixed(4)}%
                        </td>
                        <td>$${item.open_interest.toLocaleString()}</td>
                        <td><span class="badge bg-secondary">${item.data_source}</span></td>
                        <td>
                            ${item.enabled ?
                                '<span class="badge bg-success">å¯ç”¨</span>' :
                                '<span class="badge bg-danger">ç¦ç”¨</span>'}
                        </td>
                    </tr>
                `).join('');

                // æ›´æ–°æ´»è·ƒå¸ç§æ•°
                const activeCount = result.data.filter(item => item.enabled).length;
                document.getElementById('activeSymbols').textContent = activeCount;

            } catch (error) {
                console.error('Failed to update market overview:', error);
            }
        }

        // æ›´æ–°äº¤æ˜“ä¿¡å·
        async function updateSignals() {
            try {
                const response = await fetch('/api/signals');
                const result = await response.json();

                if (!result.success) {
                    console.error('API error:', result.error);
                    return;
                }

                const tbody = document.getElementById('signalsTable');
                const alertsContainer = document.getElementById('alertsContainer');

                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">æš‚æ— ä¿¡å·</td></tr>';
                } else {
                    tbody.innerHTML = result.data.map(signal => `
                        <tr>
                            <td><strong>${signal.symbol}</strong></td>
                            <td><span class="badge ${signal.type === 'BULLISH' ? 'bg-success' : signal.type === 'BEARISH' ? 'bg-danger' : 'bg-warning'}">${signal.type}</span></td>
                            <td><strong class="positive">${signal.strength}</strong></td>
                            <td>$${signal.price.toFixed(2)}</td>
                            <td class="${signal.funding_rate > 0 ? 'negative' : 'positive'}">
                                ${(signal.funding_rate * 100).toFixed(4)}%
                            </td>
                            <td class="${signal.sentiment > 0 ? 'positive' : signal.sentiment < 0 ? 'negative' : 'neutral'}">
                                ${signal.sentiment > 0 ? '+' : ''}${signal.sentiment}
                            </td>
                            <td><small>${new Date(signal.timestamp).toLocaleTimeString()}</small></td>
                        </tr>
                    `).join('');

                    // æ›´æ–°å‘Šè­¦
                    const allAlerts = result.all_alerts || result.data.flatMap(s => s.alerts || []);
                    if (allAlerts.length > 0) {
                        alertsContainer.innerHTML = allAlerts.map(alert => `
                            <div class="alert-box alert-critical">
                                <i class="bi bi-bell-fill"></i> ${alert}
                            </div>
                        `).join('');
                    } else {
                        alertsContainer.innerHTML = '<div class="text-muted text-center py-3">æš‚æ— å‘Šè­¦</div>';
                    }
                }

                document.getElementById('activeSignals').textContent = result.data.length;

            } catch (error) {
                console.error('Failed to update signals:', error);
            }
        }

        // æ›´æ–°æ–°é—»
        async function updateNews() {
            try {
                const response = await fetch('/api/news');
                const result = await response.json();

                if (!result.success) {
                    console.error('API error:', result.error);
                    return;
                }

                const container = document.getElementById('newsContainer');

                if (result.count === 0) {
                    container.innerHTML = '<div class="text-muted text-center py-3">æš‚æ— æ–°é—»</div>';
                } else {
                    container.innerHTML = result.data.map(news => `
                        <div class="news-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <a href="${news.url || '#'}" target="_blank" class="text-decoration-none text-light">
                                        <strong>${news.title}</strong>
                                    </a>
                                    <div class="text-muted small mt-1">
                                        <i class="bi bi-clock"></i> ${news.published_at ? new Date(news.published_at).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                document.getElementById('newsCount').textContent = result.count;

            } catch (error) {
                console.error('Failed to update news:', error);
            }
        }

        // æ›´æ–°é²¸é±¼åŠ¨æ€
        async function updateWhaleAlerts() {
            try {
                const response = await fetch('/api/whale_alerts');
                const result = await response.json();

                if (!result.success) {
                    console.error('API error:', result.error);
                    return;
                }

                const container = document.getElementById('whaleAlertsContainer');

                if (result.count === 0) {
                    container.innerHTML = '<div class="text-muted text-center py-3">æš‚æ— å¤§é¢äº¤æ˜“</div>';
                } else {
                    container.innerHTML = result.data.map(tx => {
                        const typeIcon = tx.type === 'buy' ? 'ğŸ“ˆ' : tx.type === 'sell' ? 'ğŸ“‰' : 'ğŸ”„';
                        const typeClass = tx.type === 'buy' ? 'positive' : tx.type === 'sell' ? 'negative' : 'neutral';
                        const valueFormatted = (tx.value_usd / 1000000).toFixed(2);

                        return `
                            <div class="news-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div>
                                            ${typeIcon} <strong>${tx.symbol}</strong>
                                            <span class="${typeClass}">$${valueFormatted}M</span>
                                        </div>
                                        <div class="text-muted small mt-1">
                                            ${tx.description || tx.type}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.error('Failed to update whale alerts:', error);
            }
        }

        // æ›´æ–°æƒ…ç»ªåˆ†æ
        async function updateSentiment() {
            try {
                const symbols = {{ symbols | tojson }};
                const sentiments = [];

                for (const symbol of symbols.slice(0, 5)) {  // å‰5ä¸ªå¸ç§
                    // URLç¼–ç symbolå‚æ•°ï¼Œé¿å…è·¯å¾„åˆ†éš”ç¬¦é—®é¢˜
                    const encodedSymbol = encodeURIComponent(symbol);
                    const response = await fetch(`/api/sentiment/${encodedSymbol}`);
                    const result = await response.json();

                    if (result.success) {
                        sentiments.push({
                            symbol: symbol.replace('/USDT', ''),
                            score: result.data.total_score
                        });
                    }
                }

                // æ›´æ–°å›¾è¡¨
                if (sentimentChart) {
                    sentimentChart.data.labels = sentiments.map(s => s.symbol);
                    sentimentChart.data.datasets[0].data = sentiments.map(s => s.score);
                    sentimentChart.update();
                }

                // è®¡ç®—å¹³å‡æƒ…ç»ª
                const avgSentiment = sentiments.reduce((sum, s) => sum + s.score, 0) / sentiments.length;
                const sentimentText = avgSentiment > 10 ? 'ä¹è§‚' : avgSentiment < -10 ? 'æ‚²è§‚' : 'ä¸­æ€§';
                const sentimentClass = avgSentiment > 10 ? 'positive' : avgSentiment < -10 ? 'negative' : 'neutral';

                document.getElementById('marketSentiment').textContent = sentimentText;
                document.getElementById('marketSentiment').className = `metric-value ${sentimentClass}`;
                document.getElementById('sentimentScore').textContent = `${avgSentiment.toFixed(1)}åˆ†`;

            } catch (error) {
                console.error('Failed to update sentiment:', error);
            }
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAll() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('loading');

            try {
                await Promise.all([
                    updateMarketOverview(),
                    updateSignals(),
                    updateNews(),
                    updateWhaleAlerts(),
                    updateSentiment()
                ]);

                document.getElementById('updateTime').textContent = new Date().toLocaleString('zh-CN');
            } finally {
                btn.classList.remove('loading');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initSentimentChart();
            refreshAll();

            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(refreshAll, 30000);
        });
    </script>
</body>
</html>
