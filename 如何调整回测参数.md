# 如何调整回测参数

## 问题说明

用户反馈：
1. `run_multi_timeframe_backtest.py` 中**没有 `start_date` 和 `end_date` 参数**
2. 配置了8个交易对，但只有3个被回测

## 解决方案

### 1. 交易对配置（已修复）

**位置**：`config/strategy_params.py` 第205-214行

```python
TRADING_SYMBOLS = [
    'BTC/USDT',
    'ETH/USDT',
    'SOL/USDT',
    'SNX/USDT',
    'BNB/USDT',
    'SUI/USDT',
    '1000RATS/USDT',
    'M/USDT',
]
```

现在 `run_multi_timeframe_backtest.py` 会**自动读取**这个配置。

---

### 2. 回测时长调整

**位置**：`run_multi_timeframe_backtest.py` 第89-95行

```python
# 时间周期配置（可修改 days 参数来调整回测时长）
# 例如：{'days': 90} = 回测最近90天数据
timeframes = {
    '1h': {'days': 60, 'desc': '1小时（60天数据）'},
    '30m': {'days': 60, 'desc': '30分钟（60天数据）'},
    '15m': {'days': 60, 'desc': '15分钟（60天数据）'},
}
```

**如何修改**：

| 需求 | 修改方式 | 示例 |
|-----|---------|------|
| 回测最近90天 | 改 `days: 60` → `days: 90` | `'30m': {'days': 90, ...}` |
| 回测最近30天 | 改 `days: 60` → `days: 30` | `'30m': {'days': 30, ...}` |
| 只测试30分钟周期 | 删除其他时间周期 | 只保留 `'30m': {...}` |

**注意**：
- 系统会获取**最近N天的数据**，而不是指定具体日期范围
- 不同交易所的历史数据长度不同（Binance最多500天，Hyperliquid可能更短）
- 如果请求的数据量超过交易所限制，会自动调整

---

### 3. 时间范围说明

**当前设计**：
- 使用 `days` 参数（相对时间）
- 从**当前时间往回推**N天
- 通过 `calculate_limit()` 函数计算需要多少根K线

**计算规则**（第38-49行）：
```python
bars_per_day = {
    '15m': 96根/天,   # 24*4
    '30m': 48根/天,   # 24*2
    '1h': 24根/天,    # 24*1
}

# 示例：30m周期，60天
limit = 48 * 60 + 200 = 3080根K线
```

---

## 完整使用流程

### 步骤1：配置交易对
编辑 `config/strategy_params.py`：
```python
TRADING_SYMBOLS = [
    'BTC/USDT',
    'ETH/USDT',
    # 添加你想测试的交易对...
]
```

### 步骤2：调整回测时长（可选）
编辑 `run_multi_timeframe_backtest.py` 第92-94行：
```python
timeframes = {
    '1h': {'days': 90, 'desc': '1小时（90天数据）'},   # 改为90天
    '30m': {'days': 90, 'desc': '30分钟（90天数据）'},
    '15m': {'days': 90, 'desc': '15分钟（90天数据）'},
}
```

### 步骤3：运行回测
```bash
python3 run_multi_timeframe_backtest.py
```

### 步骤4：查看结果
```bash
python3 analyze_results.py
```

---

## 未来改进建议

如果需要指定具体日期范围（例如：2025-09-01 ~ 2025-10-27），需要修改：

1. **修改 `backtest_engine.py`**：
   - 第57-59行添加 `start_date` 和 `end_date` 参数
   - 第82行的 `DataCollector` 支持日期范围过滤

2. **修改 `data_collector.py`**：
   - 添加日期范围过滤逻辑

3. **修改 `run_multi_timeframe_backtest.py`**：
   - 第89-95行改为日期范围配置

但当前的 `days` 参数设计**更简单实用**，因为：
- 不需要手动计算日期
- 总是获取最新数据
- 自动适应不同交易所的数据可用性

---

## 常见问题

### Q1: 为什么只回测了3个交易对？
**A**: 服务器的配置文件只有3个交易对。现在已修改为8个，重新运行回测即可。

### Q2: 如何延长回测时间到2个月？
**A**: 修改 `run_multi_timeframe_backtest.py` 第92行：
```python
'30m': {'days': 60, ...}  # 改为
'30m': {'days': 60, ...}  # 2个月 ≈ 60天（已经是60天）
```
如果要更长：
```python
'30m': {'days': 90, ...}  # 3个月
```

### Q3: 为什么没有 start_date 和 end_date 参数？
**A**: 当前设计使用 `days` 参数（相对时间），而不是绝对日期。这样更灵活，总是获取最新数据。

### Q4: 如何只测试最优的30分钟周期？
**A**: 修改 `run_multi_timeframe_backtest.py` 第91-95行：
```python
timeframes = {
    '30m': {'days': 60, 'desc': '30分钟（60天数据）'},
    # 注释掉其他周期
}
```

---

**版本**: v7.2 (Stage2.2)
**最后更新**: 2025-10-28
