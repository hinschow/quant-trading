# 回测流程指南

## 📋 项目结构

```
quant-trading/
├── backtest_results/           # 回测结果目录
│   ├── v3_original/           # 原始版本结果
│   ├── latest/                # 最新回测结果
│   └── README.md              # 使用说明
├── config/
│   ├── strategy_params.py     # 当前使用的策略参数（优化后）
│   └── strategy_params_optimized.py  # 优化配置参考
├── docs/
│   └── archives/              # 归档文档
├── analyze_backtest_v2.py     # 结果分析工具（新版）
├── run_backtest_all.py        # 批量回测脚本
├── cleanup.sh                 # 项目清理工具
└── ...
```

## 🚀 完整回测流程

### 在本地 Mac 执行

#### 1. 同步最新代码

```bash
cd /Volumes/datedisk\ 1/code/quant-trading
git pull
```

你会看到：
- ✅ 修复后的 `strategy_engine.py`（支持品种参数）
- ✅ 新的目录结构（`backtest_results/`）
- ✅ 更新的工具脚本

#### 2. 确认配置

```bash
# 检查当前使用的配置
python3 -c "from config.strategy_params import SYMBOL_SPECIFIC_PARAMS; import json; print(json.dumps(SYMBOL_SPECIFIC_PARAMS, indent=2))"
```

应该看到：
```json
{
  "BTC/USDT": {
    "stop_loss_pct": 0.04,
    "take_profit_pct": 0.08,
    "min_signal_strength": 65,
    "adx_threshold": 35
  },
  ...
}
```

#### 3. 运行回测

```bash
python3 run_backtest_all.py
```

脚本会：
- 自动运行 BTC、ETH、SOL 三个品种
- 显示回测进度和交易记录
- 自动保存结果到 `backtest_results/latest/`

#### 4. 分析结果

```bash
# 使用新版分析工具（会自动读取 backtest_results/latest/）
python3 analyze_backtest_v2.py
```

**重点检查：**
- ✅ 信号强度：BTC/ETH 应该 ≥ 65，SOL 应该 ≥ 55
- ✅ 交易次数：应该减少 30-40%（约 6-10 次）
- ✅ 胜率：目标 45%+
- ✅ 盈亏比：目标 >1.2

#### 5. 验证信号强度

```bash
# 查看 BTC 的信号强度
grep "BUY" backtest_results/latest/backtest_trades_BTC_USDT_1h.csv | cut -d',' -f7

# 应该全部 >= 65
```

#### 6. 保存版本

如果结果满意：
```bash
# 复制到 v4_optimized 目录永久保存
cp -r backtest_results/latest backtest_results/v4_optimized

# 添加时间戳
mv backtest_results/v4_optimized backtest_results/v4_optimized_$(date +%Y%m%d_%H%M%S)
```

#### 7. 提交结果

```bash
# 提交回测结果（可选，如果需要分享）
git add backtest_results/v4_optimized_*/
git commit -m "Backtest results v4.0 FIXED - $(date +%Y-%m-%d)

修复品种参数后的回测结果：
- BTC/USDT: [填写收益率]
- ETH/USDT: [填写收益率]
- SOL/USDT: [填写收益率]"

git push
```

## 🔍 对比分析

### 对比 v3 和 v4

```bash
# 方法一：直接对比目录
python3 compare_results.py v3_original latest

# 方法二：使用分析工具
python3 analyze_backtest_v2.py v3_original
python3 analyze_backtest_v2.py latest
```

### 查看信号分布

```bash
# 统计各信号强度的交易次数
for file in backtest_results/latest/*.csv; do
    echo "=== $(basename $file) ==="
    grep "BUY" $file | cut -d',' -f7 | sort -n | uniq -c
done
```

## ⚠️ 常见问题

### Q1: 信号强度还是有低于阈值的？

检查：
```bash
# 确认策略引擎是否包含修复
grep "SYMBOL_SPECIFIC_PARAMS" strategy_engine.py

# 应该看到导入和使用代码
```

### Q2: 结果和第一次 v4 完全一样？

说明修复未生效，需要：
1. 确认 `git pull` 拉取了最新代码
2. 重启 Python 环境（如果使用虚拟环境）
3. 删除 `__pycache__` 缓存

```bash
./cleanup.sh  # 清理缓存
```

### Q3: 交易次数没有减少？

可能原因：
- 市场在这段时间恰好有很多强信号
- 需要查看具体的信号强度分布
- 考虑调整阈值

### Q4: 结果还是亏损？

如果优化后仍然亏损：
1. 检查数据时间范围（是否市场趋势不好）
2. 尝试调整参数（可能阈值太严格或太宽松）
3. 考虑不同的时间周期（4h、1d）
4. 分析具体的失败交易原因

## 🛠️ 工具说明

### analyze_backtest_v2.py

新版分析工具，特点：
- 自动从 `backtest_results/` 读取
- 支持指定版本：`python3 analyze_backtest_v2.py v3_original`
- 显示信号强度统计

### run_backtest_all.py

批量回测脚本，特点：
- 一次运行所有品种
- 自动保存到 `backtest_results/latest/`
- 显示耗时和统计

### cleanup.sh

项目清理工具，功能：
- 清理 Python 缓存
- 删除配置备份
- 整理 CSV 文件
- 显示目录结构

使用：
```bash
./cleanup.sh
```

## 📊 预期结果

### v3 原始版本
```
总收益率: -7.20%
平均胜率: 39.18%
组合盈亏比: <1
交易次数: 11-14次/品种
```

### v4 优化版本（预期）
```
总收益率: +3-5%
平均胜率: 45%+
组合盈亏比: >1.2
交易次数: 6-10次/品种（精选交易）
信号强度: BTC/ETH ≥65, SOL ≥55
```

## 📝 记录模板

回测完成后，记录关键指标：

```
回测日期: 2025-10-28
配置版本: v4.0 (修复后)
数据范围: [自动显示]

结果：
- BTC/USDT:
  - 收益率: __%
  - 胜率: __%
  - 交易次数: __次
  - 信号强度范围: __-__

- ETH/USDT:
  - 收益率: __%
  - 胜率: __%
  - 交易次数: __次
  - 信号强度范围: __-__

- SOL/USDT:
  - 收益率: __%
  - 胜率: __%
  - 交易次数: __次
  - 信号强度范围: __-__

整体组合:
  - 总收益率: __%
  - 平均胜率: __%

结论: [成功/需要调整]
```

## 🎯 下一步

根据回测结果：

### 如果结果理想（正收益，胜率45%+）
1. ✅ 保存版本到 v4_optimized
2. ✅ 记录参数和结果
3. ✅ 考虑实盘测试（小资金）
4. ⏸️  持续监控和优化

### 如果结果需要改进
1. 🔍 分析失败交易的原因
2. 🔧 调整参数（止损、止盈、信号阈值）
3. 🧪 重新回测验证
4. 📊 对比多个版本找最佳配置

---

**创建时间**: 2025-10-28
**最后更新**: 项目结构重构后
